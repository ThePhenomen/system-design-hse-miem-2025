# System Design Document
## Дизайн системы <i>Radio music platform</i>
    
### Глоссарий
| Термин  | Определение |
| ------------- | ------------- |
| IDP  |  Identity Provider - центролизированный сервис для авторизации пользователей |
| K8s  | Kubernetes - платформа оркестрации контейнерных приложений  |
| БД  | База данных  |
| mTLS  | Mutual Transport Layer Security - это протокол, который расширяет стандартный TLS, обеспечивая аутентификацию обеих сторон соединения (клиента и сервера) |
| CI/CD | Continuous Integration/Continuous Delivery - методология разработки программного обеспечения, направленная на автоматизацию процессов сборки, тестирования и развертывания |
---

### 1. Цели и предпосылки (Отсев + Scope Refinement)

#### 1.1. Заполните контрольные вопросы

- Какая цель у стейкхолдеров?
  Повысить взаимодействие DJ со слушателями.
- Какую проблему решает система?
  Привлечь большее количество слушателей.
- Какой результат будем считать успехом?
> Из входных данных не можем выяснить.
- Как будем измерять результат?
> Из входных данных не можем выяснить.
- Для кого создается система?
  Для слушателей радио.
- Что будет, если мы не сделаем систему? 
  Меньше пользователей будет слушать радио.
- Что если сорвем сроки?
> Из входных данных не можем выяснить.
- Какие есть зависимости?
  Зависимостей нет, инфраструктура отсутствует.


#### 1.2. Бизнес-требования 

- Краткое описание бизнес-требований. Задел для детальных ФТ/НФТ.
  Требуется реализовать:
  - практически real-time синхронизацию приложения с музыкой в эфире;
  - механизм голосования пользователей за музыку
  - возможность регистрации пользователей
  - чат пользователей
  - доступность с мобильных приложений
- Описание бизнесовых ограничений.
> Из входных данных не можем выяснить.
- (опционально) BPMN-диаграмма.


#### 1.3. Скоуп проекта  (Scope Refinement)
Особенно важный пункт во время интервью. Если просят спроектировать большую систему (Facebook, Tinder, etc): следует взять в скоуп не более 5 основных функций, иначе можно закопаться.

В результе реализации платформы будет реализована система, удовлетворяющая следующим требованиям:
- практически real-time синхронизацию приложения с музыкой в эфире;
- механизм голосования пользователей за музыку
- механизм запроса следующего трека
- авторизация пользователей
- чат для авторизированных пользователей
- доступность с мобильных приложений


### 2. Требования и ограничения

#### 2.1 Функциональные требования (ФТ)
Вопросы к собеседнику:
- Уточнить, планируется ли в дальнейшем расширять функционал приложения: добавления донатов для передачи сообщений в эфир/выбора музыки и т.д..
- Какой штат ИТ-сотрудников есть на текущий момент, есть ли какая-либо инф-ра на текущий момент и где она расположена (узнать, где будет хостяться сервисы + определить компетенцию сотрудников заказчика).
- Нужно ли обозначать SLA (насколько критичен простой - невозможность запускать голосования и т.д.).
- Действительно ли требуется real-time система (дорого и сложно в реализации).
- Есть ли уже какое-то мобильное приложение (писать с 0 или интегрировать в имеющуюся).
- Где данное радио транслируются - в мегаполисе либо маленьких городах.

Способы фиксации: User Story, JTBD, Use Case

| ID  | User Story | Приоритет | Источник (БТ) |
| ------------- | ------------- | ------| -----|
| FT1  | Я как пользователь хочу знать, какая музыка сейчас в эфире  | Highest | BT1 |
| FT2  | Я как пользователь хочу зарегистрироваться в приложении | High | BT3 |
| FT3  | Я как пользователь хочу проголосовать за следующие трек | Highest | BT2 |
| FT4  | Я как пользователь хочу поставить мой трек в очередь | High | BT2 |
| FT5  | Я как пользователь хочу общаться с другими пользователеями | High | BT4 |
| FT6  | Я как пользователь хочу подключиться к приложению с мобильного устройства | Highest | BT5 |
| FT7  | Я как пользователь хочу получать уведомления о новых голосоваиях | Medium | BT2 |

#### 2.2 Нефункциональные требования (НФТ)


| ID  | Категория | Требование | Приоритет |
| ------------- | ------------- | ------| -----|
| NFT1  | Производительность | Приложение должно выдерживать стандартную нагрузку |  Highest | 
| NFT2  | Масштабируемость | Приложение должно поддерживать масштабирование при пиковых нагрузках |  Highest | 
| NFT3  | Масштабируемость | Приложение должно быть микросервисным |  Highest | 
| NFT4  | Безопасность | Авторизация в приложение должно быть реализовано по протоколу OAuth 2.0 |  High | 
| NFT5  | Безопасность | Вынесение front сервисов в демилиторизованную зону |  High | 
| NFT6  | Мониторинг | В приложение должен быть внедрен базовый мониторинг |  Medium | 
| NFT7  | Логирование | В приложение должен быть внедрено логирование |  Low | 
| NFT8  | Надежность | Хранилища должны иметь резервные инстансы |  High | 
| NFT9  | Удобство администрирования | Сервисы должны быть удобны в развертывании и администрировании |  Medium | 
| NFT10  | Документация | Должен быть реализован стандартный пакет документации |  Medium | 


#### 2.3 Расчет нагрузки

**Трафик:**
- Предположим, что для Москвы. Тогда:
    * В Москве проживает 11 млн человек.
    * Большинство времени радио слушают в машине.
    * В среднем на одну семью (3 человека) приходится 1 машина.
    * Предположим, что наше радио лушают 10% людей.
    * Самый большой трафик в Москве утром и вечером. Предположим, что 40% людей в это время находятся за рулем.
    * Тогда получим, сколько человек одновременно могут слушать радио -> 150 000 человек.
    * Определим, сколько человек может пользоваться приложением одновременно:
        *  В среднем (не все могут отвлекаться за рулем и не всем это интересно - предположим, 10% - с учетом того, что не у всех есть приложение) -> 15 000 человек. То есть при добавлении нового голования в систему могут поступать порядка 10 000 - 15 000 запросов в течении нескольких минут.
        *  Пиковая нарузка может составлять до 40% от общего количества слушателей (при розыгрышах или проигрывание нового трека) -> до 60 000 запросов в течении нескольких минут.

**БД:**
- При высокой нагрузке следует  использовать базу данных для кэша (иначе количество запросов в систему и в базу данных будет примерно совпадать - высокая нагрузка). Также при использовании реалиционной базы данных следует минимизировать количество операций записи на диск для уменьшения задержек при работе с данными.


#### 2.4 Ограничения

- Привязка к отечественному вендору (Астра, РедОС, Альт).
- Привязка к СУБД (в зависимости от того, какие уже используются).
- Как скоро должно быть готово решение (MVP или нет).
- Привязка к провайдеру инфраструктуры (On-prem, Cloud).
- Привязка к ЯП.


### 3. Проектирование

#### 3.1 High Level Design
##### 3.1.1 Интеграции

В системе присутствуют следующие сервисы:
- Мобильное приложение;
- Панель администратора DJ;
- Сервис авторизации;
- Служба каталога (содержит информацию о зарегестрированных сервисах) - под данным сервисом можно понимать БД с зарегистрированными пользователями;
- Сервис голосования;
- Сервис запросов;
- Сервис чата (добавлен по итогу проведения первой части интервью);
- Сервис очереди музыки (отображает общую очередь музыки, куда могут вносится при обработке запроса на музыку, завершения голосования);
- Сервис уведомлений (сообщает о начале голосования, возможности запросить новую музыку);
- Объектное хранилище (хранение сообщений чата, возможных картинок);
- Реляционная БД (хранение информации о музыке: жанры, исполнители, сами треки);
- Брокер сообщений;
- Балансировщик нагрузки (служит Api Gateway);
- Нереляционная БД (кэш - уменьшает загрузку на сервис очереди музыки для постоянной загрузки текущего трека/очереди).

Между рассмотренными выше сервисами существуют следующие взаимодействия:
- Сервис авторизации и прочие - синхронное;
- Сервисы голосования,запросов и сервис уведомлений - асинхронное (нет необходимости в мгновенной отправки уведомлений, в случае синхронного взаимодействия может вызвать деградацию сервиса уведомлений);
- Сервисы голосования,запросов и сервис очереди музыки - синхронное (пользователи должны быть уверены, что их музыка установится в очередь);
- Мобильное приложение, сервис очереди музыки, кеш - синхронное (пользователь должен всегда знать, какой трек сейчас играет - требование условия "near-real-time synced");
- Мобильное приложение и чат сервис - через вебсокеты.

##### 3.1.2 Проработка баз данных

Выберем объектное хранилище, совместимое с API S3. Поскольку использование AWS на текущий момент запрещено, будем искать вариант среди решений с открытым исходным кодом. Будем выбирать среди двух популярных решений: Minio и Ceph. Ceph сложен в настройке и поддержке, поэтому будем использовать Minio.
Рассмотрим конфигурацию Minio:
- Для реализации минимального отказоустойчивого решения будем использовать конфигурацию из 4 инстансов базы;
- К каждому инстансу будут подключены 4 драйвера (4 диска);
- Установим Erasure Code Stripe Size (K+M) в 16 и Erasure Code Parity в 4 (https://min.io/docs/minio/linux/operations/concepts/erasure-coding.html);
- Данная конфигурация позволит обеспечить допуск выхода из строя одного инстанса целиком (или 4 драйверов).
- Будут созданы бакеты "messages", "media" для хранения сообщений и медиа пользователей в чате.

Выберем реляционное БД. В текущих условиях использоване Oracle невозможно, поэтому остановимся на PostgreSQL, т.к. данная СУБД обладает широким community, активно развивается, содержит обширную документацию и имеет enterprise версию PostgreSQL Pro (поддерживается отечественным вендором)
Рассмотрим конфигурацию PostgreSQL:
- Будет использоваться репликация с основной копией (master-slave);
- Будут использоваться один ведущий и один ведомый узлы;
- Будет осуществляться ручное переключение ведущего узла;
- Данный вариант позволит избежать потери данных при выходе из строя ведущего узла, а также стоит имеет низкую стоимость поддержки.
- Будет создана база данных music с таблицами (минимально необходимый набор) genres, artists, albums, songs, playlists.

Выберем нереляционное БД. В качестве наиболее популярной базы данных типа ключ-значение будем использовать Redis. Данная база данных имеет широкую документацию, возможность переключения ведущего сервера на горячую.
Рассмотрим конфигурацию Redis:
- Будет использоваться Sentinel для переключения ведущего сервера;
- Будут использоваться 3 сервера, на 2-х будут установлены инстансы Sentinel и Redis, 3-ий сервер кворумный, на нем будет находится инстанс Sentinel;
- Значение кворума будет установлено в 2;
- Такая конфигурация позволит избежать прекращение работы кэша при выходе из строя ведущего узла путем автоматического переключения мастера.

#### 3.2 Deep Dive

На данном этапе расширяем систему архитектурными и программными подходами, чтобы решить определенные проблемы и достичь выполнения всех ФТ, НФТ и учесть ограничения.

##### 3.2.1 Ключевые компоненты/подходы и их назначение
| Компонент | Обоснование | Реализация |
|-----------|-------------|------------|
| Load balancer | Распределение трафика между инстансами сервисов. Без него горизонтальное масштабирование невозможно. |  HAProxy - популярный балансировщик, Envoy - мощный балансировщик |
| IDP | Авторизация пользователей для участия в чате/заказа музыки | Keycloak - стандарт SSO в наше время |
| Объектное хранилище | Хранение сообщение и вложений пользователь в чате | Minio - популярное s3 хранилище, понятное для использования и поддержки |
| Реляционная БД | Хранение информации о музыки, авторах, жанрах и т.д. | PostgreSQL - популярное решение в наше время (после ухода Oracle) |
| Брокер очередей | Реализует асинхронное взаимодействие между внутренними сервисами и сервисом отправки уведомлений | RabbitMQ - популярное решение, менее требовательное по ресурсам, более просто по настройке по сравнению с Kafka |
| Кэш | Хранение временной информации для снижения нагрузки на сервис очереди музыки постоянными запросами | Redis - популярное kv хранилище |
| Мониторинг | Получение метрик о состоянии сервисов и их визуализация  | Prometheus + Grafana - стандарт |
| Платформа для оркестрации сервисов | Требуется поддержка автомасштабирования, удобства деплоя | K8s - можно использовать готовую платформу (например Nova) |

##### 3.2.2 Рекомендуемые компоненты/подходы и их назначение
| Компонент | Обоснование | Реализация |
|-----------|-------------|------------|
| Service mesh | Доп observability, mtls, retry | Istio для данной системы избыточно, лучше использовать Cilium Service Mesh, более прост для внедрения, имеет встроенный инструмент для отслеживания трейсов Hubble (сам mesh не имеет поддержки федерации, Cluster Mesh в бете, но для данной системы это не требуется) |
| CI/CD | Удобство развертывания сервисов | Gitlab как Git репозиторий + ArgoCD для автоматизации деплоя сервисов |
| Логирование | Централизованный сбор и визуализация логов | Opensearch + Opensearch Dashboards |

#### 3.3 Итоговая архитектура решения

![изображение](https://github.com/user-attachments/assets/4ab80bd1-d78c-4bca-b422-9b83371a742e)
